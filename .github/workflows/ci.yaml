name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: BUILD & SAST (SonarQube)
  # ------------------------------------------------------------------
  build-and-sast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and Analyze with SonarQube
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub tự cấp
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        # Lệnh này chạy test, đo coverage, đẩy lên Sonar, và CHỜ kết quả (wait=true)
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
          -Dsonar.projectKey=my_project_key \
          -Dsonar.qualitygate.wait=true

      # Nếu Quality Gate Fail (VD: Coverage < 80%), quy trình sẽ FAIL tại đây và KHÔNG chạy tiếp.

  # # ------------------------------------------------------------------
  # # JOB 2: DEPLOY (Chỉ chạy khi Job 1 thành công)
  # # ------------------------------------------------------------------
  # deploy:
  #   needs: build-and-sast # Bắt buộc Job 1 phải PASS mới chạy Job này
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
      
  #     # Ví dụ deploy giả lập (Hoặc thay bằng script deploy lên AWS/VPS của bạn)
  #     - name: Deploy to Production
  #       run: echo "Deploying to https://myapp.com ..."
        
  #     # Lưu URL web vào biến môi trường để Job sau dùng
  #     - name: Save URL for DAST
  #       run: echo "TARGET_URL=https://myapp.com" >> $GITHUB_ENV

  # # ------------------------------------------------------------------
  # # JOB 3: DAST (OWASP ZAP) - Tấn công web sau khi deploy
  # # ------------------------------------------------------------------
  # dast-scan:
  #   needs: deploy # Chạy sau khi deploy xong
  #   runs-on: ubuntu-latest
  #   name: Scan Web with OWASP ZAP
  #   steps:
  #     - name: ZAP Baseline Scan
  #       uses: zaproxy/action-baseline@v0.9.0
  #       with:
  #         target: 'https://myapp.com' # Thay bằng website thật của bạn
  #         fail_action: true  # Fail job nếu tìm thấy lỗi High/Medium