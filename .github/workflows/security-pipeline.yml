name: DevSecOps Pipeline (Git Push Trigger)

# --- PH·∫¶N QUAN TR·ªåNG NH·∫§T ---
on:
  push:
    branches: [ "main" ] # K√≠ch ho·∫°t khi push v√†o nh√°nh main
  # V·∫´n gi·ªØ c√°i n√†y ƒë·ªÉ n·∫øu c·∫ßn th√¨ b·∫•m ch·∫°y th·ªß c√¥ng tr√™n web GitHub
  workflow_dispatch: 

jobs:
  security-scan:
    name: Build - SAST - DAST
    runs-on: self-hosted # Ch·∫°y tr√™n m√°y c·ªßa b·∫°n
    
    steps:
      # 1. L·∫•y code m·ªõi nh·∫•t t·ª´ GitHub v·ªÅ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. C√†i ƒë·∫∑t Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Qu√©t SAST (SonarQube)
      - name: SAST - SonarQube Scan
        run: |
          mvn clean verify sonar:sonar -Dsonar.projectKey=qlcb-project -Dsonar.host.url=http://localhost:9000 -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      
      # 4. Kh·ªüi ƒë·ªông Web App (Port 8080)
      - name: Start Spring Boot App
        run: |
          echo "üöÄ ƒêang kh·ªüi ƒë·ªông ·ª©ng d·ª•ng t·ª´ code v·ª´a push..."
          # Ch·∫°y ng·∫ßm tr√™n Windows
          Start-Process -FilePath "mvn" -ArgumentList "spring-boot:run" -NoNewWindow
          echo "‚è≥ ƒê·ª£i 40 gi√¢y cho server ·ªïn ƒë·ªãnh..."
          sleep 40 

      # 5. Qu√©t DAST (OWASP ZAP)
      - name: DAST - OWASP ZAP Scan
        continue-on-error: true
        run: |
          docker pull ghcr.io/zaproxy/zaproxy:stable
          
          # T·∫•n c√¥ng v√†o localhost:8080, ZAP n√© sang 8081
          docker run --network="host" -v ${{ github.workspace }}:/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://localhost:8080 -r zap_report.html -z "-port 8081"
          
      # 6. D·ªçn d·∫πp (T·∫Øt app sau khi test xong)
      - name: Stop App
        if: always()
        run: taskkill /F /IM java.exe || echo "Java process not found"

      # 7. Upload b√°o c√°o ZAP l√™n GitHub
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: ZAP-Security-Report
          path: zap_report.html