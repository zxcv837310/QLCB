<!DOCTYPE html>
<html lang="zxx" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Cake | Admin Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/flaticon.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/barfiller.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/elegant-icons.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/nice-select.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/owl.carousel.min.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/slicknav.min.css}" type="text/css">
    <link rel="stylesheet" th:href="@{/css/style.css}" type="text/css">
    
    <style>
        .admin-section { padding: 50px 0; }
        .nav-tabs .nav-link { color: #333; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #f08632; border-bottom: 2px solid #f08632; }
        .table img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
        .form-control { margin-bottom: 15px; }
        .status-select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
        /* Style cho thanh search */
        .search-bar { background: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #eee; }
    </style>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="header__top__inner" style="padding: 20px 0;">
                        <div class="header__logo">
                            <a th:href="@{/shop}"><img th:src="@{/img/logo.png}" alt=""></a>
                        </div>
                        <div class="header__top__right">
                            <h5 style="display: inline-block; margin-right: 15px;">Admin Dashboard</h5>
                            <a th:href="@{/logout}" class="site-btn" style="padding: 10px 20px; font-size: 14px; background-color: #f08632; color: white;">
                                <i class="fa fa-sign-out"></i> Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section class="admin-section spad">
        <div class="container">
            <ul class="nav nav-tabs" id="adminTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="menu-tab" data-toggle="tab" href="#menu" role="tab">Menu Management</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="order-tab" data-toggle="tab" href="#order" role="tab">Order Management</a>
                </li>
            </ul>

            <div class="tab-content" id="adminTabContent" style="padding-top: 30px;">
                
                <div class="tab-pane fade show active" id="menu" role="tabpanel">
                    
                    <div class="search-bar">
                        <form th:action="@{/admin}" method="get">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <input type="text" name="keyword" class="form-control" 
                                           placeholder="Search by Item Name..." 
                                           th:value="${currentKeyword}" style="margin-bottom: 0;">
                                </div>
                                <div class="col-md-3">
                                    <select name="category" class="form-control" style="margin-bottom: 0; height: 45px;">
                                        <option value="">All Categories</option>
                                        <option th:each="cat : ${categories}" 
                                                th:value="${cat}" 
                                                th:text="${cat}"
                                                th:selected="${cat == currentCategory}"></option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="site-btn" style="width: 100%; padding: 10px 0;">Search</button>
                                </div>
                                <div class="col-md-3 text-right">
                                    <button type="button" class="site-btn" data-toggle="modal" data-target="#addMenuModal" style="background-color: #111;">
                                        + Add New Item
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <table class="table table-bordered table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>Image</th>
                                <th>Item Name</th>
                                <th>Price</th>
                                <th>Category</th>
                                <th style="width: 30%;">Description</th>
                                <th style="width: 18%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="menu : ${menus}">
                                <td>
                                    <img th:if="${menu.imageUrl != null and (menu.imageUrl.startsWith('http') or menu.imageUrl.startsWith('https'))}"
                                         th:src="${menu.imageUrl}" alt="Online Img">
                                         
                                    <img th:if="${menu.imageUrl != null and !menu.imageUrl.startsWith('http') and !menu.imageUrl.startsWith('https')}"
                                         th:src="@{'/' + ${menu.imageUrl}}" alt="Local Img">
                                         
                                    <img th:if="${menu.imageUrl == null or menu.imageUrl == ''}"
                                         th:src="@{/img/shop/product-1.jpg}" alt="Default">
                                </td>
                                <td th:text="${menu.name}" style="font-weight: bold;">Name</td>
                                <td th:text="'$' + ${#numbers.formatDecimal(menu.price, 0, 'COMMA', 2, 'POINT')}">Price</td>
                                <td><span class="badge badge-info" th:text="${menu.category}">Cat</span></td>
                                <td th:text="${menu.description}">Desc</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm btn-edit"
                                            th:data-id="${menu.id}"
                                            th:data-name="${menu.name}"
                                            th:data-price="${menu.price}"
                                            th:data-category="${menu.category}"
                                            th:data-description="${menu.description}">
                                        <i class="fa fa-pencil"></i> Edit
                                    </button>

                                    <a th:href="@{/admin/menu/delete/{id}(id=${menu.id})}" 
                                       onclick="return confirm('Are you sure you want to delete this item?')"
                                       class="btn btn-danger btn-sm"><i class="fa fa-trash"></i> Del</a>
                                </td>
                            </tr>
                            <tr th:if="${menus.isEmpty()}">
                                <td colspan="6" class="text-center">No items found matching your search.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="tab-pane fade" id="order" role="tabpanel">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Total</th>
                                <th>Order Items</th>
                                <th>Status</th>
                                <th>Update</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="order : ${orders}">
                                <td th:text="${order.orderCode}" style="font-weight:bold; color: #f08632;">Code</td>
                                <td th:text="${order.fullName}">Name</td>
                                <td th:text="${order.phoneNumber}">Phone</td>
                                <td th:text="'$' + ${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 2, 'POINT')}">Total</td>
                                <td>
                                    <ul style="list-style: none; padding: 0; font-size: 13px;">
                                        <li th:each="item : ${order.items}">
                                            - <b>[[${item.menu.name}]]</b> x[[${item.quantity}]]
                                        </li>
                                    </ul>
                                </td>
                                <td>
                                    <span class="badge" 
                                          th:classappend="${order.status == 'COMPLETED' ? 'badge-success' : (order.status == 'PENDING' ? 'badge-warning' : (order.status == 'CANCELLED' ? 'badge-danger' : 'badge-primary'))}"
                                          th:text="${order.status}">PENDING</span>
                                </td>
                                <td>
                                    <form th:action="@{/admin/order/update-status}" method="post" class="d-flex">
                                        <input type="hidden" name="orderId" th:value="${order.id}">
                                        <select name="status" class="status-select mr-2" style="font-size: 12px;">
                                            <option value="PENDING" th:selected="${order.status == 'PENDING'}">Pending</option>
                                            <option value="SHIPPING" th:selected="${order.status == 'SHIPPING'}">Shipping</option>
                                            <option value="COMPLETED" th:selected="${order.status == 'COMPLETED'}">Completed</option>
                                            <option value="CANCELLED" th:selected="${order.status == 'CANCELLED'}">Cancelled</option>
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-dark"><i class="fa fa-save"></i></button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="addMenuModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Menu Item</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/admin/menu/save}" method="post" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <label>Item Name</label>
                                <input type="text" name="name" class="form-control" placeholder="Ex: Beef Burger" required>
                            </div>
                            <div class="col-md-6">
                                <label>Price ($)</label>
                                <input type="number" name="price" class="form-control" step="0.01" placeholder="Ex: 5.99" required>
                            </div>
                            <div class="col-md-6">
                                <label>Category</label>
                                <input type="text" name="category" class="form-control" placeholder="Ex: Burger, Pizza..." required>
                            </div>
                            <div class="col-md-6">
                                <label>Image</label>
                                <input type="file" name="imageFile" class="form-control" accept="image/*" required>
                            </div>
                            <div class="col-md-12">
                                <label>Description</label>
                                <textarea name="description" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="text-right mt-3">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="site-btn">Save Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editMenuModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Menu Item</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/admin/menu/update}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="id" id="edit-id">
                        <div class="row">
                            <div class="col-md-6">
                                <label>Item Name</label>
                                <input type="text" name="name" id="edit-name" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label>Price ($)</label>
                                <input type="number" name="price" id="edit-price" class="form-control" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label>Category</label>
                                <input type="text" name="category" id="edit-category" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label>Change Image (Optional)</label>
                                <input type="file" name="imageFile" class="form-control" accept="image/*">
                                <small class="text-muted">Leave empty to keep current image</small>
                            </div>
                            <div class="col-md-12">
                                <label>Description</label>
                                <textarea name="description" id="edit-description" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="text-right mt-3">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="site-btn" style="background-color: #007bff;">Update Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/jquery-3.3.1.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/jquery.nice-select.min.js}"></script>
    <script th:src="@{/js/jquery.barfiller.js}"></script>
    <script th:src="@{/js/jquery.magnific-popup.min.js}"></script>
    <script th:src="@{/js/jquery.slicknav.js}"></script>
    <script th:src="@{/js/owl.carousel.min.js}"></script>
    <script th:src="@{/js/jquery.nicescroll.min.js}"></script>
    <script th:src="@{/js/main.js}"></script>

    <script>
        $(document).ready(function() {
            $('.btn-edit').on('click', function() {
                var id = $(this).data('id');
                var name = $(this).data('name');
                var price = $(this).data('price');
                var category = $(this).data('category');
                var description = $(this).data('description');

                $('#edit-id').val(id);
                $('#edit-name').val(name);
                $('#edit-price').val(price);
                $('#edit-category').val(category);
                $('#edit-description').val(description);

                $('#editMenuModal').modal('show');
            });
        });
    </script>
</body>
</html>